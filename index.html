<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“± ìŠ¤ë§ˆíŠ¸ í•™ì‚¬ê´€ë¦¬</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary: #339af0;
            --bg: #f1f3f5;
            --surface: #ffffff;
            --text: #212529;
            --text-muted: #868e96;
            --border: #e9ecef;
            --sun: #ff6b6b;
            --sat: #4dabf7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }

        /* í—¤ë” */
        header {
            background: var(--surface);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        header h1 { font-size: 18px; font-weight: 800; margin: 0; }
        .month-ctrl { display: flex; align-items: center; gap: 15px; font-weight: 800; }
        .btn-circle { border: none; background: #eee; width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ê³µê°„ */
        }

        /* --- íƒ­ 1: ë‹¬ë ¥ --- */
        .cal-container { background: var(--surface); border-radius: 15px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .cal-day-head { font-size: 12px; font-weight: 700; color: var(--text-muted); padding: 10px 0; }
        .cal-date-cell { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            font-weight: 600;
            border-radius: 50%;
            margin: 2px;
            position: relative;
        }
        .cal-date-cell.today { background: var(--primary); color: #fff !important; }
        .cal-date-cell.has-event::after {
            content: ''; width: 4px; height: 4px; background: #adb5bd; border-radius: 50%;
            position: absolute; bottom: 5px;
        }
        .cal-date-cell.selected { border: 2px solid var(--primary); }
        .sun { color: var(--sun); }
        .sat { color: var(--sat); }
        .other { opacity: 0.2; }

        .day-detail { margin-top: 15px; }
        .detail-card { background: var(--surface); border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary); }

        /* --- íƒ­ 2: ë¦¬ìŠ¤íŠ¸(ê³„íší‘œ) --- */
        .list-item { background: var(--surface); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .list-date { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .date-num { font-size: 18px; font-weight: 800; }
        .event-tag { 
            display: inline-block; padding: 4px 10px; border-radius: 6px; 
            font-size: 13px; font-weight: 700; margin: 3px 0;
        }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 12px; color: var(--text-muted); }
        .info-box { background: #f8f9fa; padding: 8px; border-radius: 6px; }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface); height: 65px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { 
            flex: 1; text-align: center; border: none; background: none; 
            color: var(--text-muted); font-size: 11px; font-weight: 700;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; }

        /* ë¡œë”© */
        .loading { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader" class="loading"><div class="spinner"></div><p>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>

<header>
    <h1>í•™ì‚¬ê´€ë¦¬</h1>
    <div class="month-ctrl">
        <button class="btn-circle" onclick="changeMonth(-1)">â—€</button>
        <span id="currentMonthDisplay">2024.03</span>
        <button class="btn-circle" onclick="changeMonth(1)">â–¶</button>
    </div>
</header>

<main id="app"></main>

<nav>
    <button class="nav-item active" onclick="switchTab('cal', this)"><i>ğŸ—“ï¸</i><span>ë‹¬ë ¥</span></button>
    <button class="nav-item" onclick="switchTab('list', this)"><i>ğŸ“‹</i><span>ê³„íší‘œ</span></button>
    <button class="nav-item" onclick="switchTab('dept', this)"><i>ğŸ¢</i><span>ë¶€ì„œë³„</span></button>
</nav>

<script>
    const SHEET_ID = '10blDNZ4zjrFU5lwCvgtoD3npwIwcCMQTeqwPgpQ_Ffg';
    const FIXED_DEPTS = ["êµëª©ë¶€", "êµë¬´ë¶€", "ì—°êµ¬ë¶€", "ìƒë‹´ë¶€", "ì •ë³´ë¶€", "1í•™ë…„ë¶€", "2í•™ë…„ë¶€", "3í•™ë…„ë¶€", "ê¸°íšìœ„ì›", "í–‰ì •ì‹¤", "êµ­ì–´ê³¼", "ì˜ì–´ê³¼", "ìˆ˜í•™ê³¼", "ì‚¬íšŒê³¼", "ê³¼í•™ê³¼", "ì˜ˆì²´ëŠ¥ê³¼", "ì •ë³´ê³¼", "ì™¸êµ­ì–´ê³¼", "ê¸°íƒ€"];
    const deptColors = {};
    const PASTELS = ['#e7f5ff', '#fff4e6', '#f3f0ff', '#ebfbee', '#fff5f5', '#f1f3f5', '#e3fafc', '#fff9db'];
    FIXED_DEPTS.forEach((d, i) => { deptColors[d] = PASTELS[i % PASTELS.length]; });

    let scheduleData = [], supervisorMap = {}, prayerMap = {}, dataLoaded = 0;
    let viewDate = new Date();
    let currentTab = 'cal';
    let selectedDateStr = new Date().toISOString().split('T')[0];

    function parseGDate(v) {
        if (!v || typeof v !== 'string') return null;
        const parts = v.match(/\d+/g);
        return new Date(parts[0], parts[1], parts[2]);
    }

    window.cb_schedule = (data) => {
        data.table.rows.forEach(r => {
            if (!r.c || !r.c[0]) return;
            const date = parseGDate(r.c[0].v);
            const content = r.c[2] ? String(r.c[2].v) : "";
            if (date && content && content !== "null") {
                const events = content.split('\n').filter(l => l.trim() && l !== "null").map(line => {
                    const match = line.match(/^\[([^\]]+)\]/);
                    let dept = match ? match[1].trim() : 'ê¸°íƒ€';
                    let text = match ? line.replace(match[0], '').trim() : line.trim();
                    return { dept: FIXED_DEPTS.includes(dept) ? dept : 'ê¸°íƒ€', text };
                });
                if(events.length) scheduleData.push({ date, events });
            }
        });
        checkReady();
    };

    window.cb_super = (data) => {
        data.table.rows.forEach(r => {
            if (r.c && r.c[0] && r.c[2]) {
                const d = parseGDate(r.c[0].v);
                if(d) supervisorMap[d.toISOString().split('T')[0]] = r.c[2].v;
            }
        });
        checkReady();
    };

    window.cb_prayer = (data) => {
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        data.table.rows.forEach((r, i) => {
            if (i < 2 || !r.c || !r.c[0]) return;
            const day = r.c[0].v;
            prayerMap[day] = { name: r.c[1]?.v || '', info: `${r.c[2]?.v || ''} / ${r.c[3]?.v || ''}` };
        });
        checkReady();
    };

    function checkReady() {
        if (++dataLoaded >= 3) {
            document.getElementById('loader').style.display = 'none';
            render();
        }
    }

    function init() {
        const gids = [['0','cb_schedule'], ['1459415616','cb_super'], ['1697887995','cb_prayer']];
        gids.forEach(g => {
            const s = document.createElement('script');
            s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${g[1]}&gid=${g[0]}`;
            document.body.appendChild(s);
        });
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function changeMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        render();
    }

    function render() {
        const app = document.getElementById('app');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('currentMonthDisplay').innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        app.innerHTML = '';

        if (currentTab === 'cal') renderCalendar(app, y, m);
        else if (currentTab === 'list') renderList(app, y, m);
        else if (currentTab === 'dept') renderDept(app);
    }

    function renderCalendar(c) {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        const now = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ ê°ì²´ ìƒì„±

        let html = `<div class="calendar-legend no-print">${FIXED_DEPTS.map(d => `<div class="legend-item"><div class="legend-dot" style="background:${deptColors[d]}"></div>${d}</div>`).join('')}</div><div class="month-selector no-print"><button class="btn" onclick="changeMonth(-1)">â—€ ì´ì „</button><div class="month-title">${y}ë…„ ${m + 1}ì›”</div><button class="btn" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button></div><div class="calendar-wrapper"><div class="calendar-grid">${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map(d => `<div class="cal-head">${d}</div>`).join('')}`;
    
        const firstDay = new Date(y, m, 1), lastDay = new Date(y, m + 1, 0);
        let curr = new Date(firstDay);
        let diff = curr.getDay() - 1; if(diff === -1) diff = 6;
        curr.setDate(curr.getDate() - diff);

        for(let i=0; i<35; i++) {
            const dStr = curr.toISOString().split('T')[0];
            const isThisMonth = curr.getMonth() === m;
        
        // ì¤‘ìš”: ì‹œê°„ ì •ë³´ë¥¼ ì œì™¸í•˜ê³  ë‚ ì§œë§Œ ë¹„êµ (ì˜¤ëŠ˜ í•˜ì´ë¼ì´íŠ¸ ë¡œì§)
            const isToday = curr.getFullYear() === now.getFullYear() && 
                            curr.getMonth() === now.getMonth() && 
                            curr.getDate() === now.getDate();

            if(curr.getDay() !== 0 && curr.getDay() !== 6) {
                const dayData = scheduleData.find(x => x.date.toISOString().split('T')[0] === dStr);
                html += `<div class="cal-cell ${!isThisMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"><div class="cal-date">${curr.getDate()}</div>${dayData ? dayData.events.map(e => `<div class="cal-ev" style="background:${deptColors[e.dept]}" onclick="goDept('${e.dept}')">${e.text}</div>`).join('') : ''}</div>`;
            }
            curr.setDate(curr.getDate() + 1); if(curr > lastDay && curr.getDay() === 1) break;
        }
        c.innerHTML = html + `</div></div>`;
    }

    window.selectDate = (iso) => {
        selectedDateStr = iso;
        render();
    };

    function renderDayDetail() {
        const detail = document.getElementById('dayDetail');
        if(!detail) return;
        const dayData = scheduleData.find(s => s.date.toISOString().split('T')[0] === selectedDateStr);
        const supervisor = supervisorMap[selectedDateStr];
        const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(selectedDateStr).getDay()];
        const prayer = prayerMap[dayName];

        let html = `<div style="font-weight:800; margin-bottom:10px; color:var(--primary)">ğŸ“ ${selectedDateStr.split('-')[2]}ì¼ ìƒì„¸ ì¼ì •</div>`;
        if(!dayData && !supervisor) {
            html += `<div class="detail-card" style="color:var(--text-muted); text-align:center;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            if(dayData) dayData.events.forEach(e => {
                html += `<div class="detail-card" style="border-left-color:${deptColors[e.dept] || '#eee'}">
                    <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                    <div style="font-weight:700; margin-top:5px;">${e.text}</div>
                </div>`;
            });
            if(supervisor || prayer) {
                html += `<div class="info-grid">
                    <div class="info-box"><b>ê°ë…:</b> ${supervisor || '-'}</div>
                    <div class="info-box"><b>ê¸°ë„:</b> ${prayer?.name || '-'}</div>
                </div>`;
            }
        }
        detail.innerHTML = html;
    }

    function renderList(container, y, m) {
        const last = new Date(y, m + 1, 0).getDate();
        let html = '';
        for(let d=1; d<=last; d++) {
            const cur = new Date(y, m, d), dISO = cur.toISOString().split('T')[0];
            const dayData = scheduleData.find(s => s.date.toISOString().split('T')[0] === dISO);
            const supervisor = supervisorMap[dISO];
            const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][cur.getDay()];
            
            if(!dayData && !supervisor) continue;

            html += `<div class="list-item">
                <div class="list-date">
                    <span class="date-num ${cur.getDay()==0?'sun':cur.getDay()==6?'sat':''}">${d}</span>
                    <span style="font-weight:700; color:var(--text-muted)">${dayName}ìš”ì¼</span>
                </div>
                ${dayData ? dayData.events.map(e => `
                    <div style="margin-bottom:8px;">
                        <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                        <div style="font-weight:700; padding-left:5px;">${e.text}</div>
                    </div>
                `).join('') : ''}
                <div class="info-grid">
                    <div class="info-box">ê°ë…: ${supervisor || '-'}</div>
                    <div class="info-box">ê¸°ë„: ${prayerMap[dayName]?.name || '-'}</div>
                </div>
            </div>`;
        }
        container.innerHTML = html || '<p style="text-align:center; padding:50px; color:#999;">ì´ë²ˆ ë‹¬ì€ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function renderDept(container) {
        if(!window._selDept) window._selDept = FIXED_DEPTS[0];
        let html = `<select style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); font-size:16px; font-weight:700; margin-bottom:20px;" onchange="window._selDept=this.value; render();">
            ${FIXED_DEPTS.map(d => `<option ${window._selDept==d?'selected':''}>${d}</option>`).join('')}
        </select>`;

        const filtered = scheduleData.filter(s => s.events.some(e => e.dept === window._selDept)).sort((a,b)=>a.date-b.date);
        
        if(!filtered.length) html += `<p style="text-align:center; padding:50px; color:#999;">ë“±ë¡ëœ ë¶€ì„œ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        else {
            filtered.forEach(s => {
                const isThisMonth = s.date.getMonth() === viewDate.getMonth();
                if(!isThisMonth) return;
                html += `<div class="list-item" style="border-left:5px solid ${deptColors[window._selDept]}">
                    <div style="font-weight:800; margin-bottom:5px;">${s.date.getMonth()+1}ì›” ${s.date.getDate()}ì¼</div>
                    ${s.events.filter(e => e.dept === window._selDept).map(e => `<div style="font-weight:600;">â€¢ ${e.text}</div>`).join('')}
                </div>`;
            });
        }
        container.innerHTML = html;
    }

    init();
</script>
</body>
</html>
