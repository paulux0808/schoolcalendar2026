<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“± ìŠ¤ë§ˆíŠ¸ í•™ì‚¬ê´€ë¦¬</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary: #1c7ed6;
            --primary-light: #d0ebff;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #212529;
            --text-muted: #868e96;
            --border: #e9ecef;
            --sun: #fa5252;
            --sat: #228be6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* í—¤ë” */
        header {
            background: var(--surface);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
        }
        header h1 { font-size: 19px; font-weight: 800; margin: 0; color: var(--primary); letter-spacing: -0.5px; }
        .month-ctrl { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 16px; }
        .btn-circle { border: none; background: #f1f3f5; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; scroll-behavior: smooth; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .cal-container { background: var(--surface); border-radius: 20px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; }
        .cal-day-head { font-size: 11px; font-weight: 700; color: var(--text-muted); padding: 8px 0; text-align: center; }
        
        .cal-date-cell { 
            aspect-ratio: 0.9; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            padding-top: 8px;
            font-size: 15px; 
            font-weight: 700;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        /* ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° */
        .cal-date-cell.today { background: var(--primary-light); color: var(--primary); }
        /* ì„ íƒëœ ë‚ ì§œ ê°•ì¡° */
        .cal-date-cell.selected { background: #343a40; color: #fff !important; }
        .cal-date-cell.other { opacity: 0.15; pointer-events: none; }
        
        /* ì¼ì • í‘œì‹œ ë°” */
        .event-bars { display: flex; flex-direction: column; gap: 2px; width: 80%; margin-top: 4px; }
        .bar { height: 3px; border-radius: 2px; width: 100%; }

        /* ìƒì„¸ ì •ë³´ ì¹´ë“œ */
        .day-detail-title { font-size: 17px; font-weight: 800; margin: 20px 0 12px 5px; display: flex; align-items: center; gap: 8px; }
        .detail-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .event-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 800; margin-bottom: 8px; color: #444; }
        .event-text { font-size: 15px; font-weight: 700; line-height: 1.4; }

        /* í•˜ë‹¨ ì •ë³´ ë°•ìŠ¤ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .info-box { background: #f8f9fa; padding: 12px; border-radius: 12px; font-size: 13px; border: 1px solid var(--border); }
        .info-box b { color: var(--primary); display: block; margin-bottom: 4px; font-size: 11px; text-transform: uppercase; }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); height: 75px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: var(--text-muted); font-size: 11px; font-weight: 700; display: flex; flex-direction: column; gap: 5px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; font-style: normal; }

        /* ë¡œë”© í™”ë©´ */
        .loading { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .sun { color: var(--sun); }
        .sat { color: var(--sat); }
    </style>
</head>
<body>

<div id="loader" class="loading"><div class="spinner"></div><p style="margin-top:15px; font-weight:600; color:var(--text-muted)">ì •ë³´ë¥¼ ë™ê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p></div>

<header>
    <h1>ìŠ¤ë§ˆíŠ¸ í•™ì‚¬ê´€ë¦¬</h1>
    <div class="month-ctrl">
        <button class="btn-circle" onclick="changeMonth(-1)">â®</button>
        <span id="currentMonthDisplay">2024.03</span>
        <button class="btn-circle" onclick="changeMonth(1)">â¯</button>
    </div>
</header>

<main id="app"></main>

<nav id="bottomNav">
    <button class="nav-item active" onclick="switchTab('cal', this)"><i>ğŸ“…</i><span>ë‹¬ë ¥</span></button>
    <button class="nav-item" onclick="switchTab('list', this)"><i>ğŸ“‹</i><span>ì „ì²´ì¼ì •</span></button>
    <button class="nav-item" onclick="switchTab('dept', this)"><i>ğŸ¢</i><span>ë¶€ì„œë³„</span></button>
</nav>

<script>
    const SHEET_ID = '10blDNZ4zjrFU5lwCvgtoD3npwIwcCMQTeqwPgpQ_Ffg';
    const FIXED_DEPTS = ["êµëª©ë¶€", "êµë¬´ë¶€", "ì—°êµ¬ë¶€", "ìƒë‹´ë¶€", "ì •ë³´ë¶€", "1í•™ë…„ë¶€", "2í•™ë…„ë¶€", "3í•™ë…„ë¶€", "ê¸°íšìœ„ì›", "í–‰ì •ì‹¤", "êµ­ì–´ê³¼", "ì˜ì–´ê³¼", "ìˆ˜í•™ê³¼", "ì‚¬íšŒê³¼", "ê³¼í•™ê³¼", "ì˜ˆì²´ëŠ¥ê³¼", "ì •ë³´ê³¼", "ì™¸êµ­ì–´ê³¼", "ê¸°íƒ€"];
    const PASTELS = ['#e7f5ff', '#fff4e6', '#f3f0ff', '#ebfbee', '#fff5f5', '#e3fafc', '#fff9db', '#f1f3f5'];
    const deptColors = {};
    FIXED_DEPTS.forEach((d, i) => { deptColors[d] = PASTELS[i % PASTELS.length]; });

    let scheduleData = [], supervisorMap = {}, prayerMap = {}, dataLoaded = 0;
    let viewDate = new Date(); // ë‹¬ë ¥ì—ì„œ ë³´ì—¬ì£¼ëŠ” ê¸°ì¤€ ë‚ ì§œ
    let currentTab = 'cal';
    
    // ë¡œì»¬ ê¸°ì¤€ YYYY-MM-DD ë¬¸ìì—´ ìƒì„± (í•µì‹¬: ë‚ ì§œ ì–´ê¸‹ë‚¨ ë°©ì§€)
    function toDateKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    const todayStr = toDateKey(new Date());
    let selectedDateStr = todayStr;

    // êµ¬ê¸€ ì‹œíŠ¸ ë‚ ì§œ íŒŒì‹± (Date ê°ì²´ ë°˜í™˜)
    function parseGDate(v) {
        if (!v) return null;
        const m = v.match(/\d+/g);
        return m ? new Date(m[0], m[1], m[2]) : null;
    }

    window.cb_schedule = (data) => {
        data.table.rows.forEach(r => {
            if (!r.c || !r.c[0]) return;
            const d = parseGDate(r.c[0].v);
            const content = r.c[2] ? String(r.c[2].v) : "";
            if (d && content && content !== "null") {
                const events = content.split('\n').filter(l => l.trim()).map(line => {
                    const match = line.match(/^\[([^\]]+)\]/);
                    let dept = match ? match[1].trim() : 'ê¸°íƒ€';
                    return { dept: FIXED_DEPTS.includes(dept) ? dept : 'ê¸°íƒ€', text: line.replace(/^\[[^\]]+\]/, '').trim() };
                });
                if(events.length) scheduleData.push({ dateStr: toDateKey(d), events });
            }
        });
        checkReady();
    };

    window.cb_super = (data) => {
        data.table.rows.forEach(r => {
            if (r.c && r.c[0] && r.c[2]) {
                const d = parseGDate(r.c[0].v);
                if(d) supervisorMap[toDateKey(d)] = r.c[2].v;
            }
        });
        checkReady();
    };

    window.cb_prayer = (data) => {
        data.table.rows.forEach((r, i) => {
            if (i < 2 || !r.c || !r.c[0]) return;
            prayerMap[r.c[0].v] = { name: r.c[1]?.v || '', info: r.c[2]?.v || '' };
        });
        checkReady();
    };

    function checkReady() {
        if (++dataLoaded >= 3) {
            document.getElementById('loader').style.display = 'none';
            render();
        }
    }

    function init() {
        const gids = [['0','cb_schedule'], ['1459415616','cb_super'], ['1697887995','cb_prayer']];
        gids.forEach(g => {
            const s = document.createElement('script');
            s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${g[1]}&gid=${g[0]}`;
            document.body.appendChild(s);
        });
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function changeMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        render();
    }

    function render() {
        const app = document.getElementById('app');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('currentMonthDisplay').innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        app.innerHTML = '';

        if (currentTab === 'cal') renderCalendar(app, y, m);
        else if (currentTab === 'list') renderList(app, y, m);
        else if (currentTab === 'dept') renderDept(app);
    }

    function renderCalendar(container, y, m) {
        let html = `<div class="cal-container"><div class="cal-grid">`;
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d, i) => {
            html += `<div class="cal-day-head ${i==0?'sun':i==6?'sat':''}">${d}</div>`;
        });

        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        const prevLastDate = new Date(y, m, 0).getDate();

        // ì´ì „ ë‹¬ ë¹ˆì¹¸
        for(let i = firstDay - 1; i >= 0; i--) {
            html += `<div class="cal-date-cell other">${prevLastDate - i}</div>`;
        }

        // ì´ë²ˆ ë‹¬ ë‚ ì§œ
        for(let d = 1; d <= lastDate; d++) {
            const curDate = new Date(y, m, d);
            const dStr = toDateKey(curDate);
            const isToday = dStr === todayStr;
            const isSelected = dStr === selectedDateStr;
            const dayOfWeek = curDate.getDay();
            const dayData = scheduleData.find(x => x.dateStr === dStr);

            html += `
                <div class="cal-date-cell ${isToday?'today':''} ${isSelected?'selected':''} ${dayOfWeek==0?'sun':dayOfWeek==6?'sat':''}" 
                     onclick="selectDate('${dStr}')">
                    ${d}
                    <div class="event-bars">
                        ${dayData ? dayData.events.slice(0,2).map(e => `<div class="bar" style="background:${deptColors[e.dept]}"></div>`).join('') : ''}
                    </div>
                </div>`;
        }
        html += `</div></div><div id="dayDetailArea"></div>`;
        container.innerHTML = html;
        renderDayDetail();
    }

    window.selectDate = (dStr) => {
        selectedDateStr = dStr;
        render(); // ì „ì²´ ë Œë” ëŒ€ì‹  ì„ íƒ íš¨ê³¼ë§Œ ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ ë°ì´í„° ì •í•©ì„±ì„ ìœ„í•´ ì¬ëœë”
    };

    function renderDayDetail() {
        const area = document.getElementById('dayDetailArea');
        if(!area) return;
        const dayData = scheduleData.find(s => s.dateStr === selectedDateStr);
        const supervisor = supervisorMap[selectedDateStr];
        const dateObj = new Date(selectedDateStr);
        const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dateObj.getDay()];
        const prayer = prayerMap[dayName];

        let html = `<div class="day-detail-title">ğŸ“… ${selectedDateStr.split('-')[2]}ì¼ (${dayName}ìš”ì¼)</div>`;
        
        if(!dayData && !supervisor) {
            html += `<div class="detail-card" style="color:var(--text-muted); text-align:center; border:none; background:#f1f3f5;">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            if(dayData) dayData.events.forEach(e => {
                html += `<div class="detail-card" style="border-left-color:${deptColors[e.dept]}">
                    <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                    <div class="event-text">${e.text}</div>
                </div>`;
            });
            if(supervisor || prayer) {
                html += `<div class="info-grid">
                    <div class="info-box"><b>ê´€ë¦¬ê°ë…</b>${supervisor || '-'}</div>
                    <div class="info-box"><b>ê²½ê±´íšŒê¸°ë„</b>${prayer ? prayer.name + ' ('+prayer.info+')' : '-'}</div>
                </div>`;
            }
        }
        area.innerHTML = html;
    }

    function renderList(container, y, m) {
        const last = new Date(y, m + 1, 0).getDate();
        let html = '<div style="padding-top:5px;">';
        let count = 0;
        for(let d=1; d<=last; d++) {
            const cur = new Date(y, m, d), dStr = toDateKey(cur);
            const dayData = scheduleData.find(s => s.dateStr === dStr);
            const supervisor = supervisorMap[dStr];
            if(!dayData && !supervisor) continue;

            const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][cur.getDay()];
            count++;
            html += `<div class="detail-card">
                <div style="font-weight:800; font-size:15px; margin-bottom:12px; display:flex; justify-content:space-between;">
                    <span>${d}ì¼ (${dayName})</span>
                    <span style="color:var(--primary); font-size:12px;">${supervisor || ''}</span>
                </div>
                ${dayData ? dayData.events.map(e => `
                    <div style="margin-bottom:10px;">
                        <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                        <div class="event-text">${e.text}</div>
                    </div>
                `).join('') : ''}
            </div>`;
        }
        container.innerHTML = count > 0 ? html + '</div>' : '<p style="text-align:center; padding:50px; color:#999;">ì´ë²ˆ ë‹¬ì€ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function renderDept(container) {
        if(!window._selDept) window._selDept = FIXED_DEPTS[0];
        let html = `<select style="width:100%; padding:15px; border-radius:15px; border:2px solid var(--primary); font-size:16px; font-weight:800; margin-bottom:20px; background:white; appearance:none;" onchange="window._selDept=this.value; render();">
            ${FIXED_DEPTS.map(d => `<option ${window._selDept==d?'selected':''}>${d}</option>`).join('')}
        </select>`;

        const filtered = scheduleData.filter(s => s.events.some(e => e.dept === window._selDept))
                        .sort((a,b) => a.dateStr.localeCompare(b.dateStr));
        
        let hasContent = false;
        filtered.forEach(s => {
            const [sy, sm, sd] = s.dateStr.split('-');
            if(parseInt(sm) === viewDate.getMonth() + 1) {
                hasContent = true;
                html += `<div class="detail-card" style="border-left-color:${deptColors[window._selDept]}">
                    <div style="font-weight:800; margin-bottom:8px; color:var(--primary); font-size:14px;">${sm}ì›” ${sd}ì¼</div>
                    ${s.events.filter(e => e.dept === window._selDept).map(e => `<div class="event-text">â€¢ ${e.text}</div>`).join('')}
                </div>`;
            }
        });
        
        if(!hasContent) html += `<div style="text-align:center; padding:60px 20px; color:var(--text-muted);">í•´ë‹¹ ë¶€ì„œì˜ ${viewDate.getMonth()+1}ì›” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        container.innerHTML = html;
    }

    init();
</script>
</body>
</html>
