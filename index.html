<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“± ìŠ¤ë§ˆíŠ¸ í•™ì‚¬ê´€ë¦¬</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary: #339af0;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #212529;
            --text-muted: #868e96;
            --border: #e9ecef;
            --sun: #ff6b6b;
            --sat: #4dabf7;
            --today-bg: #e7f5ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* í—¤ë” */
        header {
            background: var(--surface);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        header h1 { font-size: 18px; font-weight: 800; margin: 0; color: var(--primary); }
        .month-ctrl { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 17px; }
        .btn-circle { border: none; background: #f1f3f5; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* ë©”ì¸ ì˜ì—­ */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        .cal-container { background: var(--surface); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; }
        .cal-day-head { font-size: 12px; font-weight: 700; color: var(--text-muted); padding: 10px 0; text-align: center; }
        
        .cal-date-cell { 
            aspect-ratio: 0.8; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 5px 2px;
            font-size: 14px; 
            font-weight: 600;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
        }
        .cal-date-cell.today { background: var(--today-bg); color: var(--primary); }
        .cal-date-cell.selected { border: 2px solid var(--primary); }
        .cal-date-cell.other { opacity: 0.2; }
        
        /* ì¼ì • í‘œì‹œ ì /ë°” */
        .event-dots { display: flex; gap: 2px; margin-top: 4px; flex-wrap: wrap; justify-content: center; }
        .dot { width: 5px; height: 5px; border-radius: 50%; }

        /* ìƒì„¸ ì¹´ë“œ */
        .day-detail { margin-top: 20px; }
        .detail-card { background: var(--surface); border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .event-tag { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-bottom: 5px; }

        /* í•˜ë‹¨ ë„¤ë¹„ */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface); height: 70px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: var(--text-muted); font-size: 11px; font-weight: 700; display: flex; flex-direction: column; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; font-style: normal; }

        /* ê³µí†µ ì •ë³´ ë°•ìŠ¤ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .info-box { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 12px; border: 1px solid var(--border); }
        .info-box b { color: var(--primary); margin-right: 4px; }

        /* ë¡œë”© */
        .loading { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .sun { color: var(--sun); }
        .sat { color: var(--sat); }
    </style>
</head>
<body>

<div id="loader" class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</p></div>

<header>
    <h1>ìŠ¤ë§ˆíŠ¸ í•™ì‚¬</h1>
    <div class="month-ctrl">
        <button class="btn-circle" onclick="changeMonth(-1)">â—€</button>
        <span id="currentMonthDisplay">2024.03</span>
        <button class="btn-circle" onclick="changeMonth(1)">â–¶</button>
    </div>
</header>

<main id="app"></main>

<nav>
    <button class="nav-item active" onclick="switchTab('cal', this)"><i>ğŸ“…</i><span>ë‹¬ë ¥</span></button>
    <button class="nav-item" onclick="switchTab('list', this)"><i>ğŸ“‹</i><span>ì „ì²´ì¼ì •</span></button>
    <button class="nav-item" onclick="switchTab('dept', this)"><i>ğŸ¢</i><span>ë¶€ì„œë³„</span></button>
</nav>

<script>
    const SHEET_ID = '10blDNZ4zjrFU5lwCvgtoD3npwIwcCMQTeqwPgpQ_Ffg';
    const FIXED_DEPTS = ["êµëª©ë¶€", "êµë¬´ë¶€", "ì—°êµ¬ë¶€", "ìƒë‹´ë¶€", "ì •ë³´ë¶€", "1í•™ë…„ë¶€", "2í•™ë…„ë¶€", "3í•™ë…„ë¶€", "ê¸°íšìœ„ì›", "í–‰ì •ì‹¤", "êµ­ì–´ê³¼", "ì˜ì–´ê³¼", "ìˆ˜í•™ê³¼", "ì‚¬íšŒê³¼", "ê³¼í•™ê³¼", "ì˜ˆì²´ëŠ¥ê³¼", "ì •ë³´ê³¼", "ì™¸êµ­ì–´ê³¼", "ê¸°íƒ€"];
    const PASTELS = ['#dbeafe', '#fef3c7', '#ede9fe', '#d1fae5', '#fee2e2', '#f3f4f6', '#cffafe', '#fef9c3'];
    const deptColors = {};
    FIXED_DEPTS.forEach((d, i) => { deptColors[d] = PASTELS[i % PASTELS.length]; });

    let scheduleData = [], supervisorMap = {}, prayerMap = {}, dataLoaded = 0;
    let viewDate = new Date();
    let currentTab = 'cal';
    
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
    function getLocalDateStr(date) {
        const offset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offset);
        return localDate.toISOString().split('T')[0];
    }
    
    let selectedDateStr = getLocalDateStr(new Date());

    function parseGDate(v) {
        if (!v) return null;
        const parts = v.match(/\d+/g);
        if (!parts || parts.length < 3) return null;
        // êµ¬ê¸€ ë°ì´í„° ì‹œê°í™” APIëŠ” ì›”ì„ 0ë¶€í„° ì‹œì‘í•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ í™•ì¸ í•„ìš”
        return new Date(parts[0], parts[1], parts[2]);
    }

    window.cb_schedule = (data) => {
        data.table.rows.forEach(r => {
            if (!r.c || !r.c[0]) return;
            const date = parseGDate(r.c[0].v);
            const content = r.c[2] ? String(r.c[2].v) : "";
            if (date && content && content !== "null") {
                const events = content.split('\n').filter(l => l.trim() && l !== "null").map(line => {
                    const match = line.match(/^\[([^\]]+)\]/);
                    let dept = match ? match[1].trim() : 'ê¸°íƒ€';
                    let text = match ? line.replace(match[0], '').trim() : line.trim();
                    return { dept: FIXED_DEPTS.includes(dept) ? dept : 'ê¸°íƒ€', text };
                });
                if(events.length) scheduleData.push({ dateStr: getLocalDateStr(date), events });
            }
        });
        checkReady();
    };

    window.cb_super = (data) => {
        data.table.rows.forEach(r => {
            if (r.c && r.c[0] && r.c[2]) {
                const d = parseGDate(r.c[0].v);
                if(d) supervisorMap[getLocalDateStr(d)] = r.c[2].v;
            }
        });
        checkReady();
    };

    window.cb_prayer = (data) => {
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        data.table.rows.forEach((r, i) => {
            if (i < 2 || !r.c || !r.c[0]) return;
            const day = r.c[0].v;
            prayerMap[day] = { name: r.c[1]?.v || '', info: `${r.c[2]?.v || ''}` };
        });
        checkReady();
    };

    function checkReady() {
        if (++dataLoaded >= 3) {
            document.getElementById('loader').style.display = 'none';
            render();
        }
    }

    function init() {
        const gids = [['0','cb_schedule'], ['1459415616','cb_super'], ['1697887995','cb_prayer']];
        gids.forEach(g => {
            const s = document.createElement('script');
            s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${g[1]}&gid=${g[0]}`;
            document.body.appendChild(s);
        });
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function changeMonth(v) {
        viewDate.setMonth(viewDate.getMonth() + v);
        render();
    }

    function render() {
        const app = document.getElementById('app');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('currentMonthDisplay').innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        app.innerHTML = '';

        if (currentTab === 'cal') renderCalendar(app, y, m);
        else if (currentTab === 'list') renderList(app, y, m);
        else if (currentTab === 'dept') renderDept(app);
    }

    function renderCalendar(container, y, m) {
        const todayStr = getLocalDateStr(new Date());
        let html = `<div class="cal-container"><div class="cal-grid">`;
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d, i) => {
            html += `<div class="cal-day-head ${i==0?'sun':i==6?'sat':''}">${d}</div>`;
        });

        const firstDay = new Date(y, m, 1);
        const lastDay = new Date(y, m + 1, 0);
        const startBlank = firstDay.getDay();
        
        // ì´ì „ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸°
        const prevLastDay = new Date(y, m, 0).getDate();
        for(let i = startBlank-1; i >= 0; i--) {
            html += `<div class="cal-date-cell other">${prevLastDay - i}</div>`;
        }

        // ì´ë²ˆ ë‹¬ ë‚ ì§œ
        for(let d = 1; d <= lastDay.getDate(); d++) {
            const curDate = new Date(y, m, d);
            const dStr = getLocalDateStr(curDate);
            const isToday = dStr === todayStr;
            const isSelected = dStr === selectedDateStr;
            const dayOfWeek = curDate.getDay();
            const dayData = scheduleData.find(x => x.dateStr === dStr);

            html += `
                <div class="cal-date-cell ${isToday?'today':''} ${isSelected?'selected':''} ${dayOfWeek==0?'sun':dayOfWeek==6?'sat':''}" 
                     onclick="selectDate('${dStr}')">
                    ${d}
                    <div class="event-dots">
                        ${dayData ? dayData.events.slice(0,3).map(e => `<div class="dot" style="background:${deptColors[e.dept]}"></div>`).join('') : ''}
                    </div>
                </div>`;
        }
        html += `</div></div><div id="dayDetail" class="day-detail"></div>`;
        container.innerHTML = html;
        renderDayDetail();
    }

    window.selectDate = (dStr) => {
        selectedDateStr = dStr;
        render();
    };

    function renderDayDetail() {
        const detail = document.getElementById('dayDetail');
        if(!detail) return;
        const dayData = scheduleData.find(s => s.dateStr === selectedDateStr);
        const supervisor = supervisorMap[selectedDateStr];
        const dateObj = new Date(selectedDateStr);
        const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dateObj.getDay()];
        const prayer = prayerMap[dayName];

        let html = `<div style="font-weight:800; margin-bottom:12px; font-size:16px;">ğŸ“… ${selectedDateStr.split('-')[2]}ì¼ (${dayName}) ì¼ì •</div>`;
        
        if(!dayData && !supervisor) {
            html += `<div class="detail-card" style="color:var(--text-muted); text-align:center; border:none;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            if(dayData) dayData.events.forEach(e => {
                html += `<div class="detail-card" style="border-left-color:${deptColors[e.dept]}">
                    <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                    <div style="font-weight:700;">${e.text}</div>
                </div>`;
            });
            if(supervisor || prayer) {
                html += `<div class="info-grid">
                    <div class="info-box"><b>ì„ì›/ê°ë…</b><br>${supervisor || '-'}</div>
                    <div class="info-box"><b>ê¸°ë„</b><br>${prayer ? prayer.name + '(' + prayer.info + ')' : '-'}</div>
                </div>`;
            }
        }
        detail.innerHTML = html;
    }

    function renderList(container, y, m) {
        const last = new Date(y, m + 1, 0).getDate();
        let html = '<div style="padding-bottom:20px;">';
        for(let d=1; d<=last; d++) {
            const cur = new Date(y, m, d), dISO = getLocalDateStr(cur);
            const dayData = scheduleData.find(s => s.dateStr === dISO);
            const supervisor = supervisorMap[dISO];
            const dayName = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][cur.getDay()];
            
            if(!dayData && !supervisor) continue;

            html += `<div class="detail-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;">
                    <span style="font-weight:800; font-size:16px;">${d}ì¼ (${dayName})</span>
                </div>
                ${dayData ? dayData.events.map(e => `
                    <div style="margin-bottom:8px;">
                        <span class="event-tag" style="background:${deptColors[e.dept]}">${e.dept}</span>
                        <div style="font-weight:700; font-size:14px;">${e.text}</div>
                    </div>
                `).join('') : ''}
                <div class="info-grid">
                    <div class="info-box"><b>ê°ë…:</b> ${supervisor || '-'}</div>
                    <div class="info-box"><b>ê¸°ë„:</b> ${prayerMap[dayName]?.name || '-'}</div>
                </div>
            </div>`;
        }
        container.innerHTML = html + '</div>' || '<p style="text-align:center; padding:50px; color:#999;">ì´ë²ˆ ë‹¬ì€ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    function renderDept(container) {
        if(!window._selDept) window._selDept = FIXED_DEPTS[0];
        let html = `<select style="width:100%; padding:14px; border-radius:12px; border:2px solid var(--primary); font-size:16px; font-weight:700; margin-bottom:20px; background:white;" onchange="window._selDept=this.value; render();">
            ${FIXED_DEPTS.map(d => `<option ${window._selDept==d?'selected':''}>${d}</option>`).join('')}
        </select>`;

        const filtered = scheduleData.filter(s => s.events.some(e => e.dept === window._selDept))
                        .sort((a,b) => a.dateStr.localeCompare(b.dateStr));
        
        let hasContent = false;
        filtered.forEach(s => {
            const sDate = new Date(s.dateStr);
            if(sDate.getMonth() === viewDate.getMonth()) {
                hasContent = true;
                html += `<div class="detail-card" style="border-left:5px solid ${deptColors[window._selDept]}">
                    <div style="font-weight:800; margin-bottom:8px; color:var(--primary);">${s.dateStr.split('-')[1]}ì›” ${s.dateStr.split('-')[2]}ì¼</div>
                    ${s.events.filter(e => e.dept === window._selDept).map(e => `<div style="font-weight:600; font-size:15px;">â€¢ ${e.text}</div>`).join('')}
                </div>`;
            }
        });
        
        if(!hasContent) html += `<p style="text-align:center; padding:50px; color:#999;">í•´ë‹¹ ì›”ì— ë“±ë¡ëœ ë¶€ì„œ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        container.innerHTML = html;
    }

    init();
</script>
</body>
</html>
